<!DOCTYPE html>

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css">
    <link href="css/login.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;700;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.12.4/jquery.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

</head>

<body>
    <nav class="navbar navbar-default">
        <div class="container-fluid">
            <div class="navbar-header">
                <button type="button" class="navbar-toggle collapsed" data-toggle="collapse"
                    data-target="#navbar-collapse" aria-expanded="false">
                    <span class="sr-only">Toggle navigation</span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                </button>
                <!-- <a class="navbar-brand" href="#">Navbar</a> -->
            </div>
            <div class="collapse navbar-collapse" id="navbar-collapse">
                <ul class="nav navbar-nav">
                    <li><a href="home.html">Home</a></li>
                    <li><a href="scan.html">Network</a></li>
                    <li><a href="benchmarks.html">Upload CIS Benchmark</a></li>
                </ul>
                <ul class="nav navbar-nav navbar-right">
                    <li><a href="#" id="Logout">Logout</a></li>
                </ul>
            </div>
        </div>
    </nav>
    <div class="justify-content-center">
        <h1 id="ipaddr"></h1>
    </div>
    <div id="loading" class="spinner-container">
        <h1>Loading Information...</h1>
        <div class="loader"></div>
    </div>
    <div id="result"></div>
    <div class="container">
        <div id="policyResults" class="table-responsive"></div>
    </div>

    <button class="btn btn-primary scanPolicy">Start New Scan</button>
    <div id="terminalOutput"></div>



    <script>
        $(document).ready(function () {
            var ipaddress = localStorage.getItem('selectedIp');
            var scanid = localStorage.getItem('scanid');
            $('#ipaddr').text(ipaddress);
            // Show the loading spinner
            var settings = {
                "url": "http://192.168.126.148:3000/scanInfo?ipaddr=" + ipaddress,
                "method": "GET",
                "timeout": 0,
            };

            $('#loading').show();
            $('#result').hide();
            $('#policyResults').hide();

            $.ajax(settings).done(function (response) {
                console.log(response);

                var resultDiv = $('#result');
                // Split the response into lines
                var lines = response.split('\n');

                // Example: Displaying the response in a formatted way
                var formattedHTML = '<h2>System Information</h2>';
                formattedHTML += '<table class="table table-bordered custom-table">';

                // Iterate through each line and parse key-value pairs
                lines.forEach(function (line) {
                    // Remove leading and trailing spaces
                    line = line.trim();
                    // Check if the line is not empty
                    if (line.length > 0) {
                        // Split the line into key and value using colon as the separator
                        var pair = line.split(':');
                        // Check if the line has both key and value
                        if (pair.length === 2) {
                            formattedHTML += '<tr><th scope="row">' + pair[0].trim() + '</th><td>' + pair[1].trim() + '</td></tr>';
                        }
                    }
                });
                formattedHTML += '</table>';
                resultDiv.html(formattedHTML);
                $('#loading').hide();
                $('#result').show();
                $.ajax({
                    "url": "http://192.168.126.148:3000/openPolicy?scanid=" + scanid,
                    "method": "GET",
                    "timeout": 0,
                    success: function (response) {
                        console.log(response);
                        var policyResults = $('#policyResults');
                        // Split the response into lines
                        var lines = response.split('\n');

                        // Example: Displaying the response in a formatted way
                        var formattedHTML = '<h2>Latest Scanned Policies</h2>';
                        formattedHTML += '<table class="table table-bordered policy-table">';

                        // Iterate through each line and parse key-value pairs
                        lines.forEach(function (line) {
                            // Remove leading and trailing spaces
                            line = line.trim();
                            // Check if the line is not empty
                            if (line.length > 0) {
                                // Split the line into key and value using colon as the separator
                                var pair = line.split(', ');
                                // Check if the line has both key and value
                                if (pair.length === 3) {
                                    formattedHTML += '<tr><th scope="row">' + pair[0].trim() + '</th><td>' + pair[1].trim().replace(/'/g, '') + '</td><td>' + pair[2].trim() + '</td></tr>';
                                }
                            }
                        });
                        formattedHTML += '</table>';
                        policyResults.html(formattedHTML);
                    },
                    error: function (error) {
                        var policyResults = $('#policyResults');
                        var formattedHTML = '<h2>Error finding latest scanned policies</h2>';
                        if (error.status == 500) {
                            console.log('.csv file was not found')
                        }
                        policyResults.html(formattedHTML);

                    }
                });
                $('#policyResults').show();
            });

            $(document).on("click", ".scanPolicy", function () {
                var settings = {
                    "url": "http://192.168.126.148:3000/policy-scan?ipaddr=" + ipaddress,
                    "method": "GET",
                    "timeout": 0,
                };

                $(document).on("click", ".scanPolicy", function () {
                    var ipaddress = localStorage.getItem('selectedIp');
                    var settings = {
                        "url": "http://192.168.126.148:3000/policy-scan?ipaddr=" + ipaddress,
                        "method": "GET",
                        "timeout": 0,
                    };

                    $.ajax(settings).done(function (response) {
                        console.log(response);

                        // Split the response into lines
                        var lines = response.split('\n');

                        // Format response as terminal output
                        var formattedHTML = '<div class="terminal">';
                        lines.forEach(function (line) {
                            formattedHTML += '<div class="response">' + line + '</div>';
                        });
                        formattedHTML += '</div>';

                        // Display formatted output
                        $('#terminalOutput').html(formattedHTML);
                    });

                });
            });





        });
    </script>
</body>

</html>