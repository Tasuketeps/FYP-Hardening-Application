<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css">
    <link href="css/login.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;700;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.12.4/jquery.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>

</head>

<body>
    <nav class="navbar navbar-default">
        <div class="container-fluid">
            <div class="navbar-header">
                <button type="button" class="navbar-toggle collapsed" data-toggle="collapse"
                    data-target="#navbar-collapse" aria-expanded="false">
                    <span class="sr-only">Toggle navigation</span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                </button>
                <!-- <a class="navbar-brand" href="#">Navbar</a> -->
            </div>
            <div class="collapse navbar-collapse" id="navbar-collapse">
                <ul class="nav navbar-nav">
                    <li><a href="home.html">Home</a></li>
                    <li><a href="scan.html">Scan Network</a></li>
                    <li><a href="scanDevice.html">Scan Device</a></li>
                    <li><a href="benchmarks.html">Upload CIS Benchmark</a></li>
                    <li><a href="register.html">Add users</a></li>
                    <li><a href="baseline.html">Configure Baseline</a></li>
                    <li><a href="settings.html">Settings</a></li>
                </ul>
                <ul class="nav navbar-nav navbar-right">
                    <li><a href="#" id="Logout">Logout</a></li>
                </ul>
            </div>
        </div>
    </nav>

    <div class="container">
        <h1>Scan Device</h1>
        <select id="ipSelect" class="form-select">
            <option selected>Select IP</option>
        </select>
        <div id="infoDisplay">
        </div>
        <select id="baselineSelect" class="form-select">
            <option selected>Select Baseline</option>
        </select>
        <button id="scanButton" class="btn btn-primary">Scan Selected IP</button>
        <div id="policyResults" class="table-responsive"></div>
        <button id="generateCSV" class="btn btn-primary" style="display: none;">Configure</button>


    </div>

    <script>
        $(document).ready(function () {
            // Retrieve scan data from sessionStorage
            $('#generateCSV').hide();
            // Check if scanData exists in sessionStorage
            if (sessionStorage.getItem('scanData')) {
                // console.log('scanData exists in sessionStorage');
                // You can also parse it back to its original format if needed
                var scanData = JSON.parse(sessionStorage.getItem('scanData'));
                // console.log(scanData);
            } else {
                $('#scanButton').prop('disabled', true);
                alert('Please perform a network scan first!')
            }

            // var scanData = sessionStorage.getItem('scanData');
            // scanData = JSON.parse(scanData)
            var ipSelect = $('#ipSelect');
            var devices = [];

            // Parse scan data into an array of objects
            var lines = scanData.split('\n');

            lines.forEach(function (line) {
                var match = line.match(/^(\d+\.\d+\.\d+\.\d+)\s+([0-9A-Fa-f:]+)\s+(.+)$/);
                if (match) {
                    var ip = match[1];
                    var lastOctet = ip.split('.').pop(); // Get the last octet of the IP address

                    // Skip IP addresses ending with .254, .1, or .2
                    if (lastOctet === '254' || lastOctet === '1' || lastOctet === '2') {
                        return; // Skip this iteration
                    }

                    // Append the device entry to the devices array
                    devices.push({
                        ip: ip,
                        mac: match[2],
                        manufacturer: match[3]
                    });
                }
            });

            // Populate the select dropdown with IP addresses
            devices.forEach(function (device) {
                ipSelect.append($('<option>', {
                    value: device.ip,
                    text: device.ip
                }));
            });

            if (devices.length === 0) {
                ipSelect.append($('<option>', {
                    value: '',
                    text: 'No IP addresses available'
                }));
                $('#scanButton').prop('disabled', true);
            }

            $('#ipSelect').on('change', function () {

                var selectedIp = $(this).val();
                var settings = {
                    "url": "https://192.168.126.148:3000/checkPolicy?ipaddr=" + selectedIp,
                    "method": "GET",
                    "timeout": 0,
                };

                $.ajax(settings).done(function (response) {
                    // console.log(response[0].scanned_filename);
                    sessionStorage.setItem('devicePolicyFileName', JSON.stringify(response[0].scanned_filename));
                });
                var selectedDevice = devices.find(device => device.ip === selectedIp);

                if (selectedDevice) {
                    $('#infoDisplay').html('MAC Address: ' + selectedDevice.mac + '<br>Manufacturer: ' + selectedDevice.manufacturer);

                } else {
                    $('#infoDisplay').html('');
                }
            });



            var settings = {
                "url": "https://192.168.126.148:3000/allBaseline",
                "method": "GET",
                "timeout": 0,
            };

            $.ajax(settings).done(function (response) {
                console.log(response);
                if (Array.isArray(response) && response.length > 0) {
                    response.forEach(function (baseline) {
                        baselineSelect.append($('<option>', {
                            value: baseline.baselineid,
                            text: baseline.filename
                        }));
                    });
                } else {
                    baselineSelect.append($('<option>', {
                        value: '',
                        text: 'No baselines available'
                    }));
                }
            });
            var baselineSelect = $('#baselineSelect');
            // Handle scan button click
            $('#scanButton').on('click', function () {
                var baseline = $('#baselineSelect option:selected').text(); // Get the text of the selected option
                if (baseline === 'Select Baseline') {
                    // Handle case where "Select Baseline" is still selected
                    alert('Please select a baseline.');
                    return; // Stop execution if no baseline is selected
                }
                var devicePolicy = sessionStorage.getItem('devicePolicyFileName');
                devicePolicy = JSON.parse(devicePolicy)
                var settings = {
                    "url": "https://192.168.126.148:3000/baseline?filename=" + baseline + "&policyFileName=" + devicePolicy + ".csv",
                    "method": "GET",
                    "timeout": 0,
                };

                $.ajax(settings).done(function (response) {
                    console.log(response);
                    var policyResults = $('#policyResults');

                    // Use PapaParse to parse the CSV response
                    var parsedData = Papa.parse(response, {
                        header: false,
                        skipEmptyLines: true,
                        quoteChar: "'",
                    }).data;

                    var formattedHTML = '<table class="table table-bordered policy-table">';
                    formattedHTML += '<thead><tr><th>No.</th><th>Policy Name</th><th>Current Value</th><th>Recommended Value</th><th>Constant Name</th></tr></thead>';
                    formattedHTML += '<tbody>';
                    counter = 0
                    parsedData.forEach(function (row) {
                        counter += 1
                        if (row[2] === 'Enabled' || row[2] === 'Disabled') {
                            if (row[1] == 0) {
                                row[1] = 'Disabled';
                            }
                            if (row[1] == 1) {
                                row[1] = 'Enabled';
                            }
                        }
                        if (row.length >= 4) {
                            formattedHTML += '<tr><td>' + counter + '</td><th scope="row">' + row[0].trim() + '</th><td>' + row[1].trim().replace(/'/g, '') + '</td><td>' + row[2].trim() + '</td><td>' + row[3].trim() + '</td></tr>';
                        }
                    });
                    formattedHTML += '</tbody></table>';
                    policyResults.html(formattedHTML);
                    $('#generateCSV').show()

                });
            });
            $('#generateCSV').on('click', function () {
                var data = [];
                const token = localStorage.getItem('token');
                var devicePolicy = sessionStorage.getItem('devicePolicyFileName');
                devicePolicy = JSON.parse(devicePolicy)
                var selectedIp = $('#ipSelect').val();
                console.log(selectedIp)
                // Select all table rows
                $('#policyResults table tbody tr').each(function () {
                    var constantName = $(this).find('td').eq(3).text();
                    var recommendedValue = $(this).find('td').eq(2).text();
                    data.push([constantName, recommendedValue]);
                });
                csvContent = "Constant Name, Recommended Value\r\n"
                data.forEach(function (rowArray) {
                    var row = rowArray[0] + ',"' + rowArray[1] + '"';
                    csvContent += row + "\r\n";
                });
                console.log(csvContent);
                var settings = {
                    url: "https://192.168.126.148:3000/updatedPolicy",
                    method: "POST",
                    timeout: 0,
                    contentType: "text/csv",
                    data: csvContent,
                    headers: {
                        'File-Name': devicePolicy,
                        'Ip-Address': selectedIp,
                        'Authorization': 'Bearer ' + token
                    }
                };

                $.ajax(settings).done(function (response) {
                    console.log(response);
                });

                // console.log(csvContent);
            });



        });
    </script>
</body>

</html>