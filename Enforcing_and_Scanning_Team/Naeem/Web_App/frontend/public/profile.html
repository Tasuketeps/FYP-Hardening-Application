<!DOCTYPE html>

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css">
    <title>Profile</title>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;700;900&display=swap" rel="stylesheet">
    <link href="css/profile.css" rel="stylesheet">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>
</head>

<body>
    <nav class="navbar navbar-default">
        <div class="container">
            <div class="navbar-header">
                <button type="button" class="navbar-toggle collapsed" data-toggle="collapse"
                    data-target="#navbar-collapse">
                    <span class="sr-only">Toggle navigation</span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                </button>
                <a class="navbar-brand" href="#"><img src="image/sp_logo.png" alt="Logo" height="50px"></a>
            </div>
            <div class="collapse navbar-collapse" id="navbar-collapse">
                <ul class="nav navbar-nav">
                    <li><a href="#">Home</a></li>
                    <li><a href="#">About</a></li>
                    <li><a href="games.html">Games</a></li>
                </ul>
                <ul class="nav navbar-nav navbar-right">
                    <li id="adminNavItem" style="display: none;">
                        <a href="#">Admin Tools</a>
                        <!-- Dropdown menu for "Admin Tools" with "Log Out" option -->
                        <ul class="dropdown-menu" id="adminDropdown" style="display: none;">
                            <li><a href="addPlatform.html" id="addPlatform">Add New Platform</a></li>
                            <li><a href="addGame.html" id="addGame">Add New Game</a></li>
                        </ul>
                    </li>
                    <li id="profileNavItem" style="display: none;">
                        <a href="profile.html">
                            <img src="https://localhost:3000/image/pic.jpg" class="rounded-circle" id="profilePic"
                                alt="Profile" height="50px">
                        </a>
                        <!-- Dropdown menu for "My Profile" with "Log Out" option -->
                        <ul class="dropdown-menu" id="logoutDropdown" style="display: none;">
                            <li><a href="index.html" id="logoutLink">Log Out</a></li>
                        </ul>
                    </li>
                    <li id="loginNavItem"><a href="login.html">Log In</a></li>
                </ul>
            </div>
        </div>
    </nav>
    <div id="welcome-header">
    </div>
    <div class="row">
        <div class="col-lg-2"></div>
        <div class="col-lg-4">
            <div class="profile-container">
                <div class="card">
                    <img src="https://localhost:3000/image/pic.jpg" id="profilePicCard" alt="Profile" style="width:100%">
                </div>
            </div>
        </div>
        <div class="col-lg-4">
            <div id="welcome-header">
            </div>
            <div class="profile-container">
                <div class="card">
                    <p class="username"> <label>Username: </label>
                        <input type="text" id="username"> </br>
                    </p>
                    <p class="type"><label>Role: </label>
                        <input type="text" id="type" readonly> </br>
                    </p>
                    <p class="email"><label>Email: </label>
                        <input type="text" id="email">
                    </p>
                    <p class="password"><label>Password: </label>
                        <input type="password" id="password">
                    </p>
                    <p class="picture"><label>Update profile picture (optional): </label>
                        <input type="file" id="profileInput" accept="image/*">
                    </p>
                    <p><span id="msg"></span></p>
                    <p><span id="msgError"></span></p>
                    <p><input type="button" id="Update" value="Update Profile" /></p>
                    <p><input type="button" id="Logout" value="Log Out" /></p>
                </div>
            </div>
        </div>
    </div>
    <script>
        const baseUrl = "https://localhost:3000";
        const token = localStorage.getItem("token");

        if (token === null) {
            window.location.assign("https://localhost:3001/login.html");;
        } else {
            var userData = localStorage.getItem('userInfo');
            var userJsonData = JSON.parse(userData);
            // put your original code in the script tag here
            $(document).ready(function () {
                $("#Update").click(function () {
                    // var userData = localStorage.getItem('userInfo');
                    // var userJsonData = JSON.parse(userData);
                    // var id = userJsonData[0].userid;
                    var tmpUName = $('#username').val();
                    var tmpEmail = $('#email').val();
                    // var tmpRole = $('#role').val();
                    var tmpPassword = $('#password').val();
                    var pfpInput = $('#profileInput')[0].files[0];

                    if (!tmpUName || !tmpEmail || !tmpPassword) {
                        $('#msgError').html('Failed! Must not have any blanks!');
                        return;
                    }

                    var tmpToken = localStorage.getItem('token');

                    // var data = "{\"username\":\""+tmpUName+"\", \"email\":\""+tmpEmail+"\", \"role\":\""+tmpRole+"\", \"password\":\""+tmpPwd+"\"}"; 
                    var data = JSON.stringify({ userid: id, email: tmpEmail, password: tmpPassword, username: tmpUName });
                    $.ajax({
                        headers: { 'authorization': 'Bearer ' + tmpToken },
                        url: 'https://localhost:3000/user',
                        type: 'PUT',
                        data: data,
                        contentType: "application/json; charset=utf-8",
                        dataType: 'json',
                        success: function (data, textStatus, xhr) {
                            if (data != null && data.success) {
                                userJsonData[0].username = tmpUName;
                                userJsonData[0].email = tmpEmail
                                if (pfpInput) {
                                    uploadImage(id, pfpInput, userJsonData)
                                }
                                $('#msg').html('Record updated successfully!');
                            } else {
                                $('#msgError').html('Error while updating profile.');
                            }
                        },
                        error: function (xhr, textStatus, errorThrown) {
                            console.log('Error in Operation');
                        }
                    });
                });

                function uploadImage(id, pfpInput,userJsonData) {
                    var formData = new FormData();
                    formData.append('', pfpInput);
                    $.ajax({
                        url: 'https://localhost:3000/user/image/' + id,
                        type: 'POST',
                        data: formData,
                        contentType: false, // Important: Don't set content type
                        processData: false, // Important: Don't process data
                        success: function (data, textStatus, xhr) {
                            userJsonData[0].profile_pic_name = pfpInput.name
                            localStorage.setItem('userInfo', JSON.stringify(userJsonData));
                        },
                        error: function (xhr, textStatus, errorThrown) {
                            if (xhr.status == 400) {
                                $('#msgError').html('Profile picture NOT updated. Only JPEG/JPG files allowed.');
                            }
                        }
                    });
                }

                function updateNavbar() {
                    if (token) {
                        var usertype = userJsonData[0].type;
                        if (usertype == 'Admin') {
                            $('#adminNavItem').css('display', 'block');
                            $('#profileNavItem').css('display', 'block');
                            $('#loginNavItem').css('display', 'none');
                        }
                        else {
                            $('#adminNavItem').css('display', 'none');
                            $('#profileNavItem').css('display', 'block');
                            $('#loginNavItem').css('display', 'none');
                        }
                    } else {
                        // User is not logged in, show "Log in" option
                        $('#profileNavItem').css('display', 'none');
                        $('#logoutDropdown').css('display', 'none');
                        $('#loginNavItem').css('display', 'block');
                    }
                }

                $('#profileNavItem').hover(function () {
                    $('#logoutDropdown').toggleClass('fade-in');
                });

                // Show dropdown menu with a sliding animation on hover
                $('#adminNavItem').hover(function () {
                    $('#adminDropdown').toggleClass('fade-in');
                });

                // Check the token on page load
                updateNavbar();

                // Log out function to remove token from local storage
                function logout() {
                    const confirmLogout = confirm("Are you sure you want to log out?");
                    if (confirmLogout) {
                        localStorage.removeItem('token');
                        localStorage.removeItem('userInfo');
                        // Update the navigation bar after logging out
                        updateNavbar();
                    } else {
                        // Prevent the default anchor link behavior
                        event.preventDefault();
                    }

                }

                // Add click event for "Log Out" option
                $('#logoutLink').click(function () {
                    logout();
                });

                // Show dropdown menu when hovering over "My Profile"
                $('#profileNavItem').hover(function () {
                    $('#logoutDropdown').css('display', 'block');
                }, function () {
                    $('#logoutDropdown').css('display', 'none');
                });
                // Show dropdown menu when hovering over "Admin Tools"
                $('#adminNavItem').hover(function () {
                    $('#adminDropdown').css('display', 'block');
                }, function () {
                    $('#adminDropdown').css('display', 'none');
                });

                $("#Logout").click(function () {
                    const confirmLogout = confirm("Are you sure you want to log out?");
                    if (confirmLogout) {
                        localStorage.removeItem('token');
                        localStorage.removeItem('userInfo');
                        window.location.assign("https://localhost:3001");
                    } else {
                        event.preventDefault();
                        return;
                    }

                });
            });
        }
        var userData = localStorage.getItem('userInfo');
        var userJsonData = JSON.parse(userData);
        var username = userJsonData[0].username;
        var useremail = userJsonData[0].email;
        var usertype = userJsonData[0].type;
        var userpic = userJsonData[0].pic;
        var userpass = userJsonData[0].password;
        var id = userJsonData[0].userid;
        var pfp_name = userJsonData[0].profile_pic_name;
        if (pfp_name !== null && pfp_name !== "") {
            // Code to execute when pfp_name is not null and not empty
            document.getElementById("profilePicCard").src = "https://localhost:3000/image/user_profile_pictures/" + pfp_name;
            document.getElementById("profilePic").src = "https://localhost:3000/image/user_profile_pictures/" + pfp_name;
        } else {
            // Code to execute when pfp_name is null or empty
            document.getElementById("profilePicCard").src = "https://localhost:3000/image/pic.jpg";
            document.getElementById("profilePic").src = "https://localhost:3000/image/pic.jpg";
        }

        $('#welcome-header').append('<p class="welcome">Welcome, ' + username + '.</p>');
        document.getElementById("username").value = username;
        document.getElementById("email").value = useremail;
        document.getElementById("type").value = usertype;

    </script>


</body>

</html>